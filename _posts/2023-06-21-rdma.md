---
layout: post
title: RDMA概述
date: 2023-06-21 10:28:00 +0800
category: 自学笔记
thumbnail: /img/cs.jpg
icon: note
---

# RDMA概述

## 0 参考资料

[RDMA资料合集](https://blog.csdn.net/zhuoweichen1/article/details/125552390)

[RDMA概述](https://blog.csdn.net/bandaoyu/article/details/112859853)

## 1 技术背景

### 1.1 传统TCP/IP网络通信的弊端

计算机网络通信中两个衡量指标：**带宽**和**延迟**

通信延迟包括：

- Transmission Delay
- Propogation Delay
- Queueing Delay
- Processing Delay

传统TCP/IP网络通信，数据通过用户空间发送到远程机器的用户空间，需要经历若干次**内存拷贝**。

两台服务器上应用之间传输数据的过程：

1. 从应用缓存拷贝到Kernel中的TCP协议栈缓存
2. 拷贝到驱动层
3. 拷贝到网卡缓存

用户空间buffer，内核空间socket buffer，NIC buffer

多次内存拷贝需要CPU多次介入

传统TCP/IP网络在**主机侧数据移动和复制操作带来的高开销**

两种解决方案：

- TOE(TCP Offloading Engine)
- RDMA(Remote Direct Memory Access)

### 1.2 新的网络通信技术

#### 1.2.1 TOE（TCP/IP协议处理工作从CPU转移到网卡）

主机通过网络进行通信，CPU的工作：数据复制、协议处理和中断处理

主机接收到网络数据包时，CPU需要对大量I/O中断信号进行响应和确认

TOE技术：将上述CPU工作转移到网卡上，需要特定支持Offloading的网卡（支持封装多层网络协议的数据包）

- 将原来在协议栈中进行的<font color='red'>IP分片、TCP分段、重组、checksum校验等操作，转移到网卡硬件中进行</font>
- 普通网卡处理每个数据包触发一次interrupt，TOE网课则让每个应用程序完成一次完整数据处理进程后才触发一次中断
- TOE网卡接收数据时，在网卡内进行协议处理，因此不必将数据复制到内核buffer，而是直接复制到用户空间buffer（零拷贝）

#### 1.2.2 RDMA（绕过CPU，数据直接传到对端内存）

Kernel Bypass和Zero Copy技术

提供了基于IO的通道，允许一个应用程序通过RDMA设备对远程的虚拟内存进行直接的读写

RDMA技术的特点：

- CPU Offload
- Kernel Bypass：提供专有的verbs interface而不是传统TCP/IP socket interface，应用程序直接在用户态执行数据传输，不需要在内核态和用户态之间做context switch
- Zero Copy：每个应用程序都能直接访问集群中的设备的虚拟内存，数据不需要被复制到网络层

Verbs Interface：在应用程序用户空间，操作RDMA硬件

RDMA绕过内核直接从用户空间访问RNIC(RDMA Network Interface Card)，RNIC中包括Cached Page Table Entry，用来将虚拟页面映射到相应的物理页面

RDMA的网卡使用需要两端都支持RDMA技术的网卡，TOE只需单端

TOE网卡和RDMA网卡都属于SmartNIC

## 2 RDMA详解（发展历程和3种技术实现）

### 2.1 DMA和RDMA概念

RDMA = Remote DMA

#### 2.1.1 DMA

传统内存访问需要通过CPU进行数据copy来移动数据，通过CPU将内存中的Buffer1移动到Buffer2

DMA(Direct Memory Access)允许在计算机主板上的设备通过DMA直接把数据发送到目标内存中去，不需要CPU参与

DMA模式：DMA Engine之间通过硬件将数据在buffer之间移动

#### 2.1.2 RDMA

绕过**远程**主机OS Kernel访问其内存中数据

RDMA允许用户态的应用程序直接读取或写入远程内存，不经过操作系统，无内核干预和内存拷贝发生，提高了系统吞吐量，降低了系统的网络通信延迟

### 2.2 RDMA三种不同的技术实现

三种不同硬件实现，使用同一套API，有不同的物理层和链路层

1. InfiniBand(IB)：基于InfiniBand架构的RDMA技术，需要专用IB网卡和IB交换机
2. RoCE(RDMA over Ethernet)：基于以太网的RDMA技术，支持在标准以太网基础设施上使用RDMA，但是需要交换机支持无损以太网传输，网卡必须是支持RoCE的特殊NIC
3. iWARP(Internet Wide Area RDMA Protocol)：基于TCP/IP协议的RDMA技术，在TCP协议上增加一层DDP(Direct Data Placement)。支持在标准以太网基础设施上使用RDMA技术，不需要交换机支持无损以太网传输，但服务器需要使用支持iWARP的网卡

上述协议均需专门硬件（NIC）支持

### 2.3 三种RDMA技术实现的关系